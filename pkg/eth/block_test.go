package eth_test

import (
	"encoding/json"
	"github.com/INFURA/eth/pkg/eth"
	"github.com/stretchr/testify/require"
	"testing"
)

func RequireEqualJSON(t *testing.T, expected, actual []byte) {
	var exp interface{}
	var act interface{}

	var err error
	err = json.Unmarshal([]byte(expected), &exp)
	require.NoError(t, err)
	err = json.Unmarshal([]byte(actual), &act)
	require.NoError(t, err)
	require.Equal(t, exp, act)
}

func TestMainnetGethBlocks(t *testing.T) {

	partial := `{
    "difficulty": "0xbfabcdbd93dda",
    "extraData": "0x737061726b706f6f6c2d636e2d6e6f64652d3132",
    "gasLimit": "0x79f39e",
    "gasUsed": "0x79ccd3",
    "hash": "0xb3b20624f8f0f86eb50dd04688409e5cea4bd02d700bf6e79e9384d47d6a5a35",
    "logsBloom": "0x4848112002a2020aaa0812180045840210020005281600c80104264300080008000491220144461026015300100000128005018401002090a824a4150015410020140400d808440106689b29d0280b1005200007480ca950b15b010908814e01911000054202a020b05880b914642a0000300003010044044082075290283516be82504082003008c4d8d14462a8800c2990c88002a030140180036c220205201860402001014040180002006860810ec0a1100a14144148408118608200060461821802c081000042d0810104a8004510020211c088200420822a082040e10104c00d010064004c122692020c408a1aa2348020445403814002c800888208b1",
    "miner": "0x5a0b54d5dc17e0aadc383d2db43b0a0d3e029c4c",
    "mixHash": "0x3d1fdd16f15aeab72e7db1013b9f034ee33641d92f71c0736beab4e67d34c7a7",
    "nonce": "0x4db7a1c01d8a8072",
    "number": "0x5bad55",
    "parentHash": "0x61a8ad530a8a43e3583f8ec163f773ad370329b2375d66433eb82f005e1d6202",
    "receiptsRoot": "0x5eced534b3d84d3d732ddbc714f5fd51d98a941b28182b6efe6df3a0fe90004b",
    "sha3Uncles": "0x8a562e7634774d3e3a36698ac4915e37fc84a2cd0044cb84fa5d80263d2af4f6",
    "size": "0x41c7",
    "stateRoot": "0xf5208fffa2ba5a3f3a2f64ebd5ca3d098978bedd75f335f56b705d8715ee2305",
    "timestamp": "0x5b541449",
    "totalDifficulty": "0x12ac11391a2f3872fcd",
    "transactions": [
      "0x8784d99762bccd03b2086eabccee0d77f14d05463281e121a62abfebcf0d2d5f",
      "0x311be6a9b58748717ac0f70eb801d29973661aaf1365960d159e4ec4f4aa2d7f",
      "0xe42b0256058b7cad8a14b136a0364acda0b4c36f5b02dea7e69bfd82cef252a2"
    ],
    "transactionsRoot": "0xf98631e290e88f58a46b7032f025969039aa9b5696498efc76baf436fa69b262",
    "uncles": [
      "0x824cce7c7c2ec6874b9fa9a9a898eb5f27cbaf3991dfa81084c3af60d1db618c"
    ]
  }`

	var block eth.Block

	err := json.Unmarshal([]byte(partial), &block)
	require.NoError(t, err, "mainnet partial block should deserialize")

	require.Equal(t, 3, len(block.Transactions))
	require.Equal(t, "0x5bad55", block.Number.String())
	require.Equal(t, uint64(0x79f39e), block.GasLimit.UInt64())

	full := `{
    "difficulty": "0x742a575f662",
    "extraData": "0xd783010302844765746887676f312e352e31856c696e7578",
    "gasLimit": "0x2fefd8",
    "gasUsed": "0x5208",
    "hash": "0x648509915efa19b169ccab758492c7525b8498747678b894befd9ff78ad05519",
    "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "miner": "0x2a65aca4d5fc5b5c859090a6c34d164135398226",
    "mixHash": "0x47e7eab7d034cf4b8b1501ebfc98edf715ee62f56283bf1a22a5423990600dff",
    "nonce": "0xeacef1c5a2ca3a49",
    "number": "0x99999",
    "parentHash": "0xffa241fbb914038a429c90daeeb54885f31e431d05b12fe87de8007853a1f278",
    "receiptsRoot": "0xb46f767bd3f69c0d7830eae6717f77560ee2ace0ea701d9e95fd41eb39a619ab",
    "sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
    "size": "0x290",
    "stateRoot": "0x93e74cf453c3327075b7e252deeb2d115cf2fdb204ba89806cebbd32afdedaa8",
    "timestamp": "0x565eafba",
    "totalDifficulty": "0x336f973a0249a1e9",
    "transactions": [
      {
        "blockHash": "0x648509915efa19b169ccab758492c7525b8498747678b894befd9ff78ad05519",
        "blockNumber": "0x99999",
        "from": "0x4bb96091ee9d802ed039c4d1a5f6216f90f81b01",
        "gas": "0xa028",
        "gasPrice": "0xba43b7400",
        "hash": "0xb4c724bf1f01a5371c513389d5758d531b729f15c8c6af8f74a100585d2cf33f",
        "input": "0x",
        "nonce": "0x461e",
        "r": "0xd5ee485b95d5992a4ca7d210ff28d540aea3f4031ce39203298ae266bcdb3485",
        "s": "0x71ecb17bdbbae8c57681649a95e8c7e22b90adac2e19c314de3b74ecfb5f8ce1",
        "to": "0x86d3856ad0105b9d4199936c1fd203664ba325dc",
        "transactionIndex": "0x0",
        "v": "0x1b",
        "value": "0x44b1eec6162f0000"
      }
    ],
    "transactionsRoot": "0x237e46a0a93850f7979546c717ffccce6715a6b2cb0bdb0d59a9c559a0d74f07",
    "uncles": []
  }`

	err = json.Unmarshal([]byte(full), &block)
	require.NoError(t, err, "mainnet full block should deserialize")

	require.Equal(t, 1, len(block.Transactions))
	require.Equal(t, "0x99999", block.Number.String())
	require.Equal(t, block.Hash, block.Transactions[0].BlockHash)
	require.Equal(t, eth.Data("0xd783010302844765746887676f312e352e31856c696e7578"), block.ExtraData)
	require.Equal(t, true, block.Transactions[0].Populated)
	require.Equal(t, int64(0), block.Transactions[0].Index.Int64())
	require.Equal(t, eth.Data("0x"), block.Transactions[0].Input)

	j, err := json.Marshal(&block)
	require.NoError(t, err)

	RequireEqualJSON(t, []byte(full), j)
}

func TestRinkebyGethBlocks(t *testing.T) {
	partial := `{
  "difficulty": "0x2",
  "extraData": "0xd883010900846765746888676f312e31312e31856c696e75780000000000000066c9aee037b7614e79d9abfc4422ced94a6ca6310e8f17be4a491ac9aaa1ebbd16e9996ad19244964781f806580459829876ab49382e8c1ed37444f17cbaffcc00",
  "gasLimit": "0x6ac95b",
  "gasUsed": "0x2b3ddc",
  "hash": "0x85a52d6d985f5c3221d2df50313950571e4772be23afca8ce410f65d4fbae66a",
  "logsBloom": "0x000c000020080000000000862100000020180008000008080000004921001000001010020014020001000000000200204000000128002000201000001000000004c00088004000810000000800002010000808001000000000000000446000010000000002000800200000000002080000000280080000000000009000000020100010c000008000000084000201000020800001044004000100280000000000020000000040000010000000400000200002000800000000000000000020011000400022000008000010814002040000080000050000200000000000080030000400002000000000820042000002800200082000100081001080080000000080",
  "miner": "0x0000000000000000000000000000000000000000",
  "mixHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
  "nonce": "0x0000000000000000",
  "number": "0x3ae0c1",
  "parentHash": "0x9b6a1fb3d50c9dd6ffe870d7828220aaede60e18aa0bc418bd3a68e06dda6ff2",
  "receiptsRoot": "0xc21fa0b7d69cc9570308066fed4cb13800d2c0799c292e3365d1824c2460d63e",
  "sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
  "size": "0x1c94",
  "stateRoot": "0x480f9a5649b844a69e75c545283cca9443cefaf0365aacd3bb4da4fb5061da97",
  "timestamp": "0x5c634043",
  "totalDifficulty": "0x6cb2df",
  "transactions": [
    "0x9490b0ccdb311bee95336ba35ce13bdbe853968672920d2e855be8467ca04484",
    "0x04871c1493f799184df5bf39f2f25b3eddb59bf91149e54f635859ffb587cdce",
    "0x79e78799b19b27dc9efada94a478728c9045f7dd239fa70f5f2f6e9ec0f53dd9",
    "0x607586f61f92dc3fc792d901a246079b78b7dd006f6e5633701ec7fd530c4e10",
    "0x0e4d4d6963f3ce12224ecdbe2f3018d3ebdda015ec65b1f74b4aea397107478b",
    "0xe5da1d2e03cdaed87fe7aa50f3456b6d230abda06b039f247b1f4d52927df4f8",
    "0xd9f393d9dbb2162db038fd84ba46155e1aa9e397dd62b955375119435aa924fe",
    "0x01a918ea5b384dd45499bd99cc5c08ec52559c3ccc12c2fbf0c1336490c78a35",
    "0xa7c78a933a9f8b9fdb48c11f53a655a7b9b1bbd14140b52b364fcabde1e1aaff",
    "0x5dbba0cd86cc68f7abeaae4dfad6ffc4ed4b4ce3e816129c938dc777c7a54cca",
    "0x20057225e2f70084397c60b34a1ee7840a6ca7d3ad363702f3df5156b3b5e051",
    "0xb037f13701cebde1e0e8e2624a1752f2f8384ca71ffe4cb591c371b715706cb5",
    "0xa6748e4441ed7dcd689c90521f2447749265c11e2be3660370f4cc6fc573ce47",
    "0x6180fbe39d0ca0044c3c4c92a62f5d70aae26afbcc4b9e494ae521b293f62a31",
    "0x7916f314e97f79217ca28eb79c573c185cf0540fe168eae16d8117ffb4e63c4a"
  ],
  "transactionsRoot": "0x8b0849114e5928a281a6a7e1d760db1fd829fe2cfb9bb98eab3fc1e386af2a9a",
  "uncles": []
}`

	var block eth.Block
	err := json.Unmarshal([]byte(partial), &block)
	require.NoError(t, err, "rinkeby partial block should deserialize")

	require.Equal(t, 15, len(block.Transactions))
	require.Equal(t, "0x3ae0c1", block.Number.String())
	require.Equal(t, uint64(0x2b3ddc), block.GasUsed.UInt64())
}

func TestKovanParityBlocks(t *testing.T) {
	full := `{
    "author": "0x007733a1fe69cf3f2cf989f81c7b4cac1693387a",
    "difficulty": "0xfffffffffffffffffffffffffffffffe",
    "extraData": "0xde830203028f5061726974792d457468657265756d86312e33312e31826c69",
    "gasLimit": "0x7a1200",
    "gasUsed": "0x2276e2",
    "hash": "0x0c58244f5d538e1f5840c6751c3b3a2c9fdf9583245918b224c6aad088de6e5a",
    "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "miner": "0x007733a1fe69cf3f2cf989f81c7b4cac1693387a",
    "number": "0x9de762",
    "parentHash": "0x7a3cce2e8ad99c92171adc9437d41eddd9e425f33b55b850528b6a9901ef0f9e",
    "receiptsRoot": "0x80add7251de396e7f6dd684e4d1be6823bdb867e96a9586c65a6f6c03659fad0",
    "sealFields": [
      "0x841718d07d",
      "0xb841e3d53556d6af10a059dd0d0d4bad2b10e3389ae08c83318b053cf04fac5c69676e96bee369cb3c11a926bbaeb25aa3ce80a101bd2d9db6f6f014b3ccbbfd7c4e00"
    ],
    "sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
    "signature": "e3d53556d6af10a059dd0d0d4bad2b10e3389ae08c83318b053cf04fac5c69676e96bee369cb3c11a926bbaeb25aa3ce80a101bd2d9db6f6f014b3ccbbfd7c4e00",
    "size": "0x2bb9",
    "stateRoot": "0x4d301d25429a2114965ce829e2c8b96b69ab826aca09aafa7fe71428d5545651",
    "step": "387502205",
    "timestamp": "0x5c6341f4",
    "totalDifficulty": "0x9ba45300000000000000000000000484a0394a",
    "transactions": [
      {
        "blockHash": "0x0c58244f5d538e1f5840c6751c3b3a2c9fdf9583245918b224c6aad088de6e5a",
        "blockNumber": "0x9de762",
        "chainId": "0x2a",
        "condition": null,
        "creates": null,
        "from": "0xd22abf44e2e2b3a9da3b84383c894f936925333c",
        "gas": "0x7a1200",
        "gasPrice": "0x3b9aca00",
        "hash": "0xd329c3a8ed5e59d649db90a1ff6c4fb632f2f5b925aedd1baa4d84b6f6b9e2f2",
        "input": "0x1a4813d700000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000009de76000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002097035c1f04f1a223413cbe3132300000000000000000000000000000000000062cb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002f69acd420fb6e6de34ec361ceddd000000000000000000000000000000000000a637000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001",
        "nonce": "0x2501b",
        "publicKey": "0xd1c9ae85381ad59eb19d55a0df58e5c0d3599d3a3766347526fd3902ad98146e89694746668c36d59378d72b4710e7f35389bd8c931390a4b908d0d84a1949bb",
        "r": "0x1686aacc780ad5a1805738bd87c709f3c0fbd5c8283be6f454aabefead5d5910",
        "raw": "0xf902cd8302501b843b9aca00837a1200945717adf502fd8830456bd5dc26801a4db394e6b280b902641a4813d700000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000009de76000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002097035c1f04f1a223413cbe3132300000000000000000000000000000000000062cb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002f69acd420fb6e6de34ec361ceddd000000000000000000000000000000000000a63700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000177a01686aacc780ad5a1805738bd87c709f3c0fbd5c8283be6f454aabefead5d5910a002d0e9cee44425e63560ce16768d8a52552ae4b386a957bdbf5e518b438e2641",
        "s": "0x2d0e9cee44425e63560ce16768d8a52552ae4b386a957bdbf5e518b438e2641",
        "standardV": "0x0",
        "to": "0x5717adf502fd8830456bd5dc26801a4db394e6b2",
        "transactionIndex": "0x0",
        "v": "0x77",
        "value": "0x0"
      },
      {
        "blockHash": "0x0c58244f5d538e1f5840c6751c3b3a2c9fdf9583245918b224c6aad088de6e5a",
        "blockNumber": "0x9de762",
        "chainId": null,
        "condition": null,
        "creates": null,
        "from": "0xb3683b4de1fc502807464b55d151e8e2d2c19cb5",
        "gas": "0xf4240",
        "gasPrice": "0x3b9aca00",
        "hash": "0x9535a683436191e42f5a4371c1c3fe6be07964e858f52d876d9e5c06e04233f5",
        "input": "0x28fbdf0d000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040376634613461663166336262326163646366313062656339636463336337636639313061303030336365323739313866366565323964376436626130353964360000000000000000000000000000000000000000000000000000000000000015332c31353530303038383134393939306131362c320000000000000000000000",
        "nonce": "0x2187c",
        "publicKey": "0x829019ea9bc42bbc7a182173191216d0386cbbf98cd35d2aa0126b8ccc8f94572dad6b218539e3a1692945ab905d34151ca8d1eea5c077104725ebff15277857",
        "r": "0xdede49403450d50a2db23a0f8d776fa94a6cae81ac8d803a29c47b4e6d63e3c",
        "raw": "0xf9014c8302187c843b9aca00830f424094cdbf1d1c64faad6d8484fd3dd5be2b4ea57f5f4c80b8e428fbdf0d000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040376634613461663166336262326163646366313062656339636463336337636639313061303030336365323739313866366565323964376436626130353964360000000000000000000000000000000000000000000000000000000000000015332c31353530303038383134393939306131362c3200000000000000000000001ba00dede49403450d50a2db23a0f8d776fa94a6cae81ac8d803a29c47b4e6d63e3ca06361f099d66bdd992a4d85c9482423a9022165b40935d5623718c82c0d897f66",
        "s": "0x6361f099d66bdd992a4d85c9482423a9022165b40935d5623718c82c0d897f66",
        "standardV": "0x0",
        "to": "0xcdbf1d1c64faad6d8484fd3dd5be2b4ea57f5f4c",
        "transactionIndex": "0x1",
        "v": "0x1b",
        "value": "0x0"
      }
    ],
    "transactionsRoot": "0x6959042602c4847d263901a7d049b5565cbd511989a7d211b319fe2a96df4ed5",
    "uncles": []
  }`

	var block eth.Block
	err := json.Unmarshal([]byte(full), &block)
	require.NoError(t, err, "kovan full parity block should deserialize")

	require.Equal(t, "0x9de762", block.Number.String())
	require.Equal(t, 2, len(block.Transactions))
	require.Equal(t, uint64(0x2276e2), block.GasUsed.UInt64())

	j, err := json.Marshal(&block)
	require.NoError(t, err)

	RequireEqualJSON(t, []byte(full), j)
}
